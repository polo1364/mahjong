<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1">
<title>麻將｜直式手機（單頁可遊玩・簡化引擎 v2）</title>
<meta name="color-scheme" content="dark">
<style>
:root{
  --safeT: env(safe-area-inset-top);
  --safeB: env(safe-area-inset-bottom);
  --gap: 8px;
  --radius: 10px;
  --shadow: 0 4px 14px rgba(0,0,0,.18);
  /* 這些尺寸會由 JS 依手牌寬度自動調整 */
  --tileW: 26px;
  --tileH: 35.1px;
  --miniW: 22px;
  --miniH: 30px;
  --font: system-ui, -apple-system, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", sans-serif;
  --bg1: #062a55; --bg2:#0a3b75;
}
*{box-sizing:border-box}
html,body{height:100%}
body{ margin:0; font-family:var(--font); color:#eaf3ff;
  background: radial-gradient(120% 90% at 50% 0%, var(--bg2) 0%, var(--bg1) 60%, #041e3c 100%);}
#app{ min-height:100vh; padding: calc(var(--safeT) + 6px) 8px calc(var(--safeB) + 8px);
  display:grid; gap: var(--gap); grid-template-rows: auto auto auto auto 1fr; }
.card{ background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  border:1px solid rgba(255,255,255,.06); border-radius: var(--radius); box-shadow: var(--shadow); padding: 8px; }
.card-title{font-size:12px;color:#8fe06b;margin-bottom:6px;font-weight:700;letter-spacing:.5px}
.topbar{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
.pill{background:#0b447f;border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:6px 10px;font-size:12px}
.btn{border-radius:999px;border:1px solid rgba(255,255,255,.16);padding:8px 12px;background:#f1b93f;color:#261a00;font-weight:800}
.dual{display:grid;grid-template-columns: 1fr 42%; gap: var(--gap)}
@media (max-width:360px){ .dual{ grid-template-columns: 1fr 44%; } }
.log{max-height:92px;overflow:auto;border-radius:8px;background:rgba(0,0,0,.18);padding:6px}
.log-item{display:flex;gap:6px;font-size:12px;padding:2px 0}
.log-item .tag{background:rgba(255,255,255,.08);border-radius:6px;padding:0 6px;font-size:11px}
.round{display:grid;gap:6px}
.rowline{display:flex;flex-wrap:wrap;gap:6px}
.badge{background:#0f4b91;color:#e7f4ff;padding:4px 8px;border-radius:999px;font-size:11px;border:1px solid rgba(255,255,255,.08)}
.actions{display:flex;gap:6px;flex-wrap:wrap;justify-content:space-between}
.actions .abtn{flex:1 1 auto;text-align:center;background:#0e4fa1;border:1px solid rgba(255,255,255,.16);border-radius:10px;padding:8px 0;font-size:13px;font-weight:800}
.actions .abtn.primary{background:#f1b93f;color:#2a1a00}
.actions .abtn[disabled]{opacity:.45}
.hand{display:flex;gap:4px;overflow-x:hidden;padding:4px;background:rgba(255,255,255,.04);border-radius:10px}
.tile{
  width:var(--tileW);height:var(--tileH);
  background:linear-gradient(180deg,#fff,#f2f6ff);color:#0e2a66;border:1px solid #d8e6ff;
  border-radius:6px;display:flex;align-items:center;justify-content:center;
  font-weight:800;font-size: calc(var(--tileW)*.4 + 8px);
  user-select:none;box-shadow:0 1px 0 rgba(0,0,0,.35),0 6px 10px rgba(0,0,0,.15);
  cursor:pointer; position:relative;
}
.tile.selected{ outline:3px solid #ffd05e; }
.tile.w{color:#e14b4b}.tile.t{color:#1976d2}.tile.s{color:#2eb972}.tile.z{color:#e14b4b}.tile.f{color:#1aa563}.tile.b{color:#777}
.players{display:grid;gap:6px}
.player{display:grid;gap:4px;padding:6px 8px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.06)}
.phead{display:flex;gap:8px;align-items:center;justify-content:space-between}
.meta{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.seat{background:#164b9a;border-radius:8px;padding:2px 6px;font-weight:800}
.banker{background:#f5c04b;color:#402;border-radius:6px;padding:0 6px;font-weight:900}
.mono{font-variant-numeric:tabular-nums}
.piles{display:grid;gap:3px}
.piles .row{display:flex;gap:4px;flex-wrap:nowrap;overflow:hidden}
.mini{width:var(--miniW);height:var(--miniH);font-size: calc(var(--miniW)*.4 + 6px)}
.small{font-size:11px;color:#9ec3ff}
.hint{font-size:11px;color:#9ec3ff;margin-top:4px}
</style>
</head>
<body>
<main id="app">
  <section class="card topbar">
    <div class="pill">台灣 16 張麻將（簡化引擎示範 v2）</div>
    <div class="pill">底 2000／每台 1000</div>
    <button class="btn" id="btn-new">開始新局</button>
  </section>
  <section class="dual">
    <div class="card">
      <div class="card-title">戰況</div>
      <div class="log" id="log"></div>
    </div>
    <aside class="card">
      <div class="card-title">牌局資訊</div>
      <div class="round">
        <div class="rowline">
          <div class="badge">場風：<span id="R_wind">東</span></div>
          <div class="badge">圈數：<span id="R_round">1</span></div>
          <div class="badge">莊家：<span id="R_banker">東</span></div>
        </div>
        <div class="rowline">
          <div class="badge">剩餘：<span id="R_left">136</span> 張</div>
          <div class="badge">金牌：<span id="R_gold">—</span></div>
        </div>
        <div class="rowline">
          <div class="badge">骰子：<span id="R_dice">—</span></div>
        </div>
      </div>
    </aside>
  </section>
  <section class="card actions">
    <button class="abtn primary" id="act-hu" disabled>胡牌</button>
    <button class="abtn" id="act-chi" disabled>吃</button>
    <button class="abtn" id="act-peng" disabled>碰</button>
    <button class="abtn" id="act-gang" disabled>槓</button>
    <button class="abtn" id="act-ting" disabled>聽</button>
    <button class="abtn" id="act-pass" >過</button>
  </section>
  <section class="card">
    <div class="card-title">你的手牌</div>
    <div class="hand" id="hand"></div>
    <div class="hint" id="hint"></div>
  </section>
  <section class="players" id="players"></section>
</main>

<script>
/* ========= 簡化引擎（可遊玩但非完整規則） ========= */
const $ = s => document.querySelector(s);
const log = (who,msg)=>{
  const row = document.createElement('div');
  row.className='log-item';
  row.innerHTML = `<span class="tag">${who}</span><span>${msg}</span>`;
  const box = $('#log'); box.appendChild(row); box.scrollTop = box.scrollHeight;
};
const tilesAll = (()=>{
  const arr = [];
  const suits = [['萬','w'],['筒','t'],['條','s']];
  for(const [s,_c] of suits){
    for(let n=1;n<=9;n++){ for(let k=0;k<4;k++) arr.push(`${n}${s}`); }
  }
  const honors = ['東','南','西','北','中','發','白'];
  honors.forEach(h=>{ for(let k=0;k<4;k++) arr.push(h); });
  return arr; // 136 張
})();
function tClass(t){ if(/萬/.test(t))return 'w'; if(/筒/.test(t))return 't'; if(/條/.test(t))return 's';
  if(t==='中')return 'z'; if(t==='發')return 'f'; if(t==='白')return 'b'; return ''; }
function tileEl(t, mini=false, clickable=false, onClick=null){
  const d = document.createElement('div');
  d.className = 'tile '+tClass(t)+(mini?' mini':'');
  d.textContent = t;
  if(clickable){ d.addEventListener('click', onClick, {passive:true}); }
  return d;
}
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=(Math.random()* (i+1))|0; [a[i],a[j]]=[a[j],a[i]];} return a; }
const order = ['東','南','西','北'];
const nextSeat = s => order[(order.indexOf(s)+1)%4];
const prevSeat = s => order[(order.indexOf(s)+3)%4];

const G = {
  deck:[], turn:'東', lastDiscard:null, lastDiscarter:null,
  players:new Map(), // seat -> {name, score, hand:[], disc:[], melds:[], banker, remain}
  needDraw:false, phase:'idle', timer:null
};
function setup(){
  G.deck = shuffle(tilesAll.slice());
  G.turn = '東';
  G.lastDiscard = null; G.lastDiscarter=null;
  G.players = new Map();
  order.forEach((s,i)=>{
    G.players.set(s, { seat:s, name: s==='東'?'你': (s==='南'?'小美': (s==='西'?'阿芬':'建國')), score:100000, hand:[], disc:[], melds:[], banker:(s==='東'), remain:16 });
  });
  deal16();
  G.phase='playing';
  G.needDraw=false; // 東家 17 張，先打
  renderAll();
  log('系統','開局完成，莊家為 東。東家請出牌。');
  enableActionsForYou();
}
function deal16(){
  // 正確發牌：每家 16，東家 +1
  order.forEach(s=>{
    const p = G.players.get(s);
    for(let i=0;i<16;i++){ p.hand.push(G.deck.pop()); }
  });
  const east = G.players.get('東');
  east.hand.push(G.deck.pop()); // 第 17 張
  order.forEach(s=> G.players.get(s).remain = G.players.get(s).hand.length);
  $('#R_left').textContent = String(G.deck.length);
}
function sortHand(h){
  const rank = t=>{
    if(/萬/.test(t)) return 100 + parseInt(t);
    if(/筒/.test(t)) return 200 + parseInt(t);
    if(/條/.test(t)) return 300 + parseInt(t);
    if(t==='東') return 401; if(t==='南') return 402; if(t==='西') return 403; if(t==='北') return 404;
    if(t==='中') return 405; if(t==='發') return 406; if(t==='白') return 407;
    return 999;
  };
  h.sort((a,b)=>rank(a)-rank(b));
}
function fitTilesToHand(){
  const you = G.players.get('東');
  const n = Math.max(you ? you.hand.length : 14, 14); // 至少預留 14
  const gap = 4;
  const box = $('#hand');
  const cw = box.clientWidth || window.innerWidth - 16;
  let w = Math.floor((cw - (n-1)*gap) / n);
  w = Math.max(18, Math.min(28, w)); // 上下限
  const h = Math.round(w*1.35);
  const miniW = Math.round(w*0.86), miniH = Math.round(h*0.86);
  const root = document.documentElement.style;
  root.setProperty('--tileW', w+'px');
  root.setProperty('--tileH', h+'px');
  root.setProperty('--miniW', miniW+'px');
  root.setProperty('--miniH', miniH+'px');
}
function renderAll(){
  fitTilesToHand();
  // 你的手牌
  const you = G.players.get('東');
  sortHand(you.hand);
  const handBox = $('#hand'); handBox.innerHTML='';
  you.hand.forEach((t,idx)=>{
    handBox.appendChild(tileEl(t,false,true,()=>onYouTapTile(idx)));
  });
  // 玩家區
  const root = $('#players'); root.innerHTML='';
  order.forEach(s=>{
    const p = G.players.get(s);
    const wrap = document.createElement('div'); wrap.className='player';
    const head = document.createElement('div'); head.className='phead';
    head.innerHTML = `<div class="meta"><span class="seat">${s}</span>${p.banker?'<span class="banker">莊</span>':''}<span>${p.name}</span></div>
      <div class="meta small"><span>💰 <span class="mono">${p.score.toLocaleString()}</span></span>
      <span>🀄 <span class="mono">${p.hand.length}</span> 張</span></div>`;
    wrap.appendChild(head);
    const piles = document.createElement('div'); piles.className='piles';
    const disc = document.createElement('div'); disc.className='row';
    p.disc.forEach(t=>disc.appendChild(tileEl(t,true,false)));
    const meld = document.createElement('div'); meld.className='row';
    p.melds.forEach(g=>{
      const gEl = document.createElement('span'); gEl.style.display='flex'; gEl.style.gap='3px';
      g.forEach(t=> gEl.appendChild(tileEl(t,true,false)));
      meld.appendChild(gEl);
    });
    piles.appendChild(disc); piles.appendChild(meld); wrap.appendChild(piles);
    root.appendChild(wrap);
  });
  $('#R_left').textContent = String(G.deck.length);
  // 動作提示
  $('#hint').textContent = (G.turn==='東' ? (G.needDraw?'請摸牌（點下方「過」）':'請出牌（點手牌）') : `等待 ${G.players.get(G.turn).name} 出牌…`);
}
function enableActionsForYou(){
  const toggle = (id, ena)=> $('#'+id).disabled = !ena;
  toggle('act-chi', false);
  toggle('act-ting', false);
  toggle('act-hu', canSevenPairs(G.players.get('東').hand)); // 七對自摸
  const last = G.lastDiscard, discarter = G.lastDiscarter;
  const you = G.players.get('東');
  let canPeng=false, canGang=false;
  if(last && discarter && discarter!== '東'){
    const cnt = you.hand.filter(x=>x===last).length;
    canPeng = cnt>=2;
    canGang = cnt>=3;
  }
  toggle('act-peng', canPeng);
  toggle('act-gang', canGang);
  toggle('act-pass', true);
}
function onYouTapTile(i){
  if(G.turn!=='東' || G.phase!=='playing') return;
  const you = G.players.get('東');
  if(G.needDraw){
    log('提示','需先摸牌（點「過」）');
    return;
  }
  const t = you.hand.splice(i,1)[0];
  you.remain = you.hand.length;
  G.lastDiscard = t; G.lastDiscarter = '東';
  you.disc.push(t);
  log('你','打出 '+t);
  G.turn = nextSeat(G.turn);
  G.needDraw = true;
  renderAll();
  scheduleAiChain();
}
function scheduleAiChain(){
  if(G.timer) { clearTimeout(G.timer); G.timer=null; }
  if(G.turn !== '東' && G.phase==='playing'){
    G.timer = setTimeout(aiTurn, 420);
  }else{
    enableActionsForYou();
  }
}
function aiTurn(){
  if(G.phase!=='playing') return;
  const p = G.players.get(G.turn);
  if(G.needDraw && G.deck.length){
    p.hand.push(G.deck.pop());
    p.remain = p.hand.length;
    G.needDraw = false;
  }
  // 簡單 AI：打第一張非字牌，否則打第一張
  let idx = p.hand.findIndex(t=>!/東|南|西|北|中|發|白/.test(t));
  if(idx<0) idx=0;
  const t = p.hand.splice(idx,1)[0];
  p.disc.push(t);
  G.lastDiscard = t; G.lastDiscarter = p.seat;
  log(p.name,'打出 '+t);
  G.turn = nextSeat(G.turn);
  G.needDraw = true; // 下一家須摸
  renderAll();
  // 若下一位仍非東家，持續串連 AI；否則換你且可反應/摸牌
  scheduleAiChain();
}
/* 動作 */
$('#act-pass').addEventListener('click',()=>{
  if(G.phase!=='playing') return;
  if(G.turn==='東' && G.needDraw){
    if(G.deck.length){
      const you = G.players.get('東');
      const t = G.deck.pop(); you.hand.push(t); you.remain = you.hand.length;
      log('你','摸到 '+t);
      G.needDraw = false;
      renderAll(); enableActionsForYou();
    }
  }else{
    // 對別人牌選擇過
    G.lastDiscard=null; G.lastDiscarter=null;
    enableActionsForYou();
  }
});
$('#act-peng').addEventListener('click',()=>{
  if(G.phase!=='playing') return;
  const last = G.lastDiscard; if(!last) return;
  const you = G.players.get('東');
  let cnt=0, keep=[]; for(const t of you.hand){ if(t===last && cnt<2){ cnt++; } else keep.push(t); }
  if(cnt===2){
    you.hand = keep;
    you.melds.push([last,last,last]);
    log('你','碰 '+last);
    G.turn='東'; G.needDraw=false; G.lastDiscard=null;
    renderAll(); enableActionsForYou();
  }
});
$('#act-gang').addEventListener('click',()=>{
  if(G.phase!=='playing') return;
  const last = G.lastDiscard; if(!last) return;
  const you = G.players.get('東');
  let cnt=0, keep=[]; for(const t of you.hand){ if(t===last && cnt<3){ cnt++; } else keep.push(t); }
  if(cnt===3){
    you.hand = keep;
    you.melds.push([last,last,last,last]);
    log('你','槓 '+last);
    if(G.deck.length){
      const t = G.deck.pop(); you.hand.push(t); you.remain = you.hand.length;
      log('你','補摸 '+t);
    }
    G.turn='東'; G.needDraw=false; G.lastDiscard=null;
    renderAll(); enableActionsForYou();
  }
});
$('#act-hu').addEventListener('click',()=>{
  if(G.phase!=='playing') return;
  const you = G.players.get('東');
  if(canSevenPairs(you.hand)){
    log('你','胡了！（七對 判定）');
    alert('恭喜自摸（七對）！本示範為簡化規則。');
    G.phase='end';
  }
});
function canSevenPairs(hand){
  const map = new Map();
  hand.forEach(t=> map.set(t, (map.get(t)||0)+1));
  let pairs=0; for(const v of map.values()){ if(v%2!==0) return false; pairs += v/2; }
  return pairs>=7 && (hand.length%2===0);
}
/* 新局 */
$('#btn-new').addEventListener('click', ()=> { setup(); });
window.addEventListener('resize', ()=>{ fitTilesToHand(); });

// 初始渲染（未開局）
(function init(){
  $('#log').innerHTML='';
  $('#hand').innerHTML='';
  $('#players').innerHTML='';
  log('系統','點「開始新局」試玩。此引擎為概念版：支援摸／打、AI 串連出牌，「碰」「槓」「七對自摸」。');
  fitTilesToHand();
})();
</script>
</body>
</html>
