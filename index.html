<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1">
<title>éº»å°‡ï½œç›´å¼æ‰‹æ©Ÿï¼ˆå–®é å¯éŠç©ãƒ»ç°¡åŒ–å¼•æ“ v2ï¼‰</title>
<meta name="color-scheme" content="dark">
<style>
:root{
  --safeT: env(safe-area-inset-top);
  --safeB: env(safe-area-inset-bottom);
  --gap: 8px;
  --radius: 10px;
  --shadow: 0 4px 14px rgba(0,0,0,.18);
  /* é€™äº›å°ºå¯¸æœƒç”± JS ä¾æ‰‹ç‰Œå¯¬åº¦è‡ªå‹•èª¿æ•´ */
  --tileW: 26px;
  --tileH: 35.1px;
  --miniW: 22px;
  --miniH: 30px;
  --font: system-ui, -apple-system, "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", sans-serif;
  --bg1: #062a55; --bg2:#0a3b75;
}
*{box-sizing:border-box}
html,body{height:100%}
body{ margin:0; font-family:var(--font); color:#eaf3ff;
  background: radial-gradient(120% 90% at 50% 0%, var(--bg2) 0%, var(--bg1) 60%, #041e3c 100%);}
#app{ min-height:100vh; padding: calc(var(--safeT) + 6px) 8px calc(var(--safeB) + 8px);
  display:grid; gap: var(--gap); grid-template-rows: auto auto auto auto 1fr; }
.card{ background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  border:1px solid rgba(255,255,255,.06); border-radius: var(--radius); box-shadow: var(--shadow); padding: 8px; }
.card-title{font-size:12px;color:#8fe06b;margin-bottom:6px;font-weight:700;letter-spacing:.5px}
.topbar{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
.pill{background:#0b447f;border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:6px 10px;font-size:12px}
.btn{border-radius:999px;border:1px solid rgba(255,255,255,.16);padding:8px 12px;background:#f1b93f;color:#261a00;font-weight:800}
.dual{display:grid;grid-template-columns: 1fr 42%; gap: var(--gap)}
@media (max-width:360px){ .dual{ grid-template-columns: 1fr 44%; } }
.log{max-height:92px;overflow:auto;border-radius:8px;background:rgba(0,0,0,.18);padding:6px}
.log-item{display:flex;gap:6px;font-size:12px;padding:2px 0}
.log-item .tag{background:rgba(255,255,255,.08);border-radius:6px;padding:0 6px;font-size:11px}
.round{display:grid;gap:6px}
.rowline{display:flex;flex-wrap:wrap;gap:6px}
.badge{background:#0f4b91;color:#e7f4ff;padding:4px 8px;border-radius:999px;font-size:11px;border:1px solid rgba(255,255,255,.08)}
.actions{display:flex;gap:6px;flex-wrap:wrap;justify-content:space-between}
.actions .abtn{flex:1 1 auto;text-align:center;background:#0e4fa1;border:1px solid rgba(255,255,255,.16);border-radius:10px;padding:8px 0;font-size:13px;font-weight:800}
.actions .abtn.primary{background:#f1b93f;color:#2a1a00}
.actions .abtn[disabled]{opacity:.45}
.hand{display:flex;gap:4px;overflow-x:hidden;padding:4px;background:rgba(255,255,255,.04);border-radius:10px}
.tile{
  width:var(--tileW);height:var(--tileH);
  background:linear-gradient(180deg,#fff,#f2f6ff);color:#0e2a66;border:1px solid #d8e6ff;
  border-radius:6px;display:flex;align-items:center;justify-content:center;
  font-weight:800;font-size: calc(var(--tileW)*.4 + 8px);
  user-select:none;box-shadow:0 1px 0 rgba(0,0,0,.35),0 6px 10px rgba(0,0,0,.15);
  cursor:pointer; position:relative;
}
.tile.selected{ outline:3px solid #ffd05e; }
.tile.w{color:#e14b4b}.tile.t{color:#1976d2}.tile.s{color:#2eb972}.tile.z{color:#e14b4b}.tile.f{color:#1aa563}.tile.b{color:#777}
.players{display:grid;gap:6px}
.player{display:grid;gap:4px;padding:6px 8px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.06)}
.phead{display:flex;gap:8px;align-items:center;justify-content:space-between}
.meta{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.seat{background:#164b9a;border-radius:8px;padding:2px 6px;font-weight:800}
.banker{background:#f5c04b;color:#402;border-radius:6px;padding:0 6px;font-weight:900}
.mono{font-variant-numeric:tabular-nums}
.piles{display:grid;gap:3px}
.piles .row{display:flex;gap:4px;flex-wrap:nowrap;overflow:hidden}
.mini{width:var(--miniW);height:var(--miniH);font-size: calc(var(--miniW)*.4 + 6px)}
.small{font-size:11px;color:#9ec3ff}
.hint{font-size:11px;color:#9ec3ff;margin-top:4px}
</style>
</head>
<body>
<main id="app">
  <section class="card topbar">
    <div class="pill">å°ç£ 16 å¼µéº»å°‡ï¼ˆç°¡åŒ–å¼•æ“ç¤ºç¯„ v2ï¼‰</div>
    <div class="pill">åº• 2000ï¼æ¯å° 1000</div>
    <button class="btn" id="btn-new">é–‹å§‹æ–°å±€</button>
  </section>
  <section class="dual">
    <div class="card">
      <div class="card-title">æˆ°æ³</div>
      <div class="log" id="log"></div>
    </div>
    <aside class="card">
      <div class="card-title">ç‰Œå±€è³‡è¨Š</div>
      <div class="round">
        <div class="rowline">
          <div class="badge">å ´é¢¨ï¼š<span id="R_wind">æ±</span></div>
          <div class="badge">åœˆæ•¸ï¼š<span id="R_round">1</span></div>
          <div class="badge">èŠå®¶ï¼š<span id="R_banker">æ±</span></div>
        </div>
        <div class="rowline">
          <div class="badge">å‰©é¤˜ï¼š<span id="R_left">136</span> å¼µ</div>
          <div class="badge">é‡‘ç‰Œï¼š<span id="R_gold">â€”</span></div>
        </div>
        <div class="rowline">
          <div class="badge">éª°å­ï¼š<span id="R_dice">â€”</span></div>
        </div>
      </div>
    </aside>
  </section>
  <section class="card actions">
    <button class="abtn primary" id="act-hu" disabled>èƒ¡ç‰Œ</button>
    <button class="abtn" id="act-chi" disabled>åƒ</button>
    <button class="abtn" id="act-peng" disabled>ç¢°</button>
    <button class="abtn" id="act-gang" disabled>æ§“</button>
    <button class="abtn" id="act-ting" disabled>è½</button>
    <button class="abtn" id="act-pass" >é</button>
  </section>
  <section class="card">
    <div class="card-title">ä½ çš„æ‰‹ç‰Œ</div>
    <div class="hand" id="hand"></div>
    <div class="hint" id="hint"></div>
  </section>
  <section class="players" id="players"></section>
</main>

<script>
/* ========= ç°¡åŒ–å¼•æ“ï¼ˆå¯éŠç©ä½†éå®Œæ•´è¦å‰‡ï¼‰ ========= */
const $ = s => document.querySelector(s);
const log = (who,msg)=>{
  const row = document.createElement('div');
  row.className='log-item';
  row.innerHTML = `<span class="tag">${who}</span><span>${msg}</span>`;
  const box = $('#log'); box.appendChild(row); box.scrollTop = box.scrollHeight;
};
const tilesAll = (()=>{
  const arr = [];
  const suits = [['è¬','w'],['ç­’','t'],['æ¢','s']];
  for(const [s,_c] of suits){
    for(let n=1;n<=9;n++){ for(let k=0;k<4;k++) arr.push(`${n}${s}`); }
  }
  const honors = ['æ±','å—','è¥¿','åŒ—','ä¸­','ç™¼','ç™½'];
  honors.forEach(h=>{ for(let k=0;k<4;k++) arr.push(h); });
  return arr; // 136 å¼µ
})();
function tClass(t){ if(/è¬/.test(t))return 'w'; if(/ç­’/.test(t))return 't'; if(/æ¢/.test(t))return 's';
  if(t==='ä¸­')return 'z'; if(t==='ç™¼')return 'f'; if(t==='ç™½')return 'b'; return ''; }
function tileEl(t, mini=false, clickable=false, onClick=null){
  const d = document.createElement('div');
  d.className = 'tile '+tClass(t)+(mini?' mini':'');
  d.textContent = t;
  if(clickable){ d.addEventListener('click', onClick, {passive:true}); }
  return d;
}
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=(Math.random()* (i+1))|0; [a[i],a[j]]=[a[j],a[i]];} return a; }
const order = ['æ±','å—','è¥¿','åŒ—'];
const nextSeat = s => order[(order.indexOf(s)+1)%4];
const prevSeat = s => order[(order.indexOf(s)+3)%4];

const G = {
  deck:[], turn:'æ±', lastDiscard:null, lastDiscarter:null,
  players:new Map(), // seat -> {name, score, hand:[], disc:[], melds:[], banker, remain}
  needDraw:false, phase:'idle', timer:null
};
function setup(){
  G.deck = shuffle(tilesAll.slice());
  G.turn = 'æ±';
  G.lastDiscard = null; G.lastDiscarter=null;
  G.players = new Map();
  order.forEach((s,i)=>{
    G.players.set(s, { seat:s, name: s==='æ±'?'ä½ ': (s==='å—'?'å°ç¾': (s==='è¥¿'?'é˜¿èŠ¬':'å»ºåœ‹')), score:100000, hand:[], disc:[], melds:[], banker:(s==='æ±'), remain:16 });
  });
  deal16();
  G.phase='playing';
  G.needDraw=false; // æ±å®¶ 17 å¼µï¼Œå…ˆæ‰“
  renderAll();
  log('ç³»çµ±','é–‹å±€å®Œæˆï¼ŒèŠå®¶ç‚º æ±ã€‚æ±å®¶è«‹å‡ºç‰Œã€‚');
  enableActionsForYou();
}
function deal16(){
  // æ­£ç¢ºç™¼ç‰Œï¼šæ¯å®¶ 16ï¼Œæ±å®¶ +1
  order.forEach(s=>{
    const p = G.players.get(s);
    for(let i=0;i<16;i++){ p.hand.push(G.deck.pop()); }
  });
  const east = G.players.get('æ±');
  east.hand.push(G.deck.pop()); // ç¬¬ 17 å¼µ
  order.forEach(s=> G.players.get(s).remain = G.players.get(s).hand.length);
  $('#R_left').textContent = String(G.deck.length);
}
function sortHand(h){
  const rank = t=>{
    if(/è¬/.test(t)) return 100 + parseInt(t);
    if(/ç­’/.test(t)) return 200 + parseInt(t);
    if(/æ¢/.test(t)) return 300 + parseInt(t);
    if(t==='æ±') return 401; if(t==='å—') return 402; if(t==='è¥¿') return 403; if(t==='åŒ—') return 404;
    if(t==='ä¸­') return 405; if(t==='ç™¼') return 406; if(t==='ç™½') return 407;
    return 999;
  };
  h.sort((a,b)=>rank(a)-rank(b));
}
function fitTilesToHand(){
  const you = G.players.get('æ±');
  const n = Math.max(you ? you.hand.length : 14, 14); // è‡³å°‘é ç•™ 14
  const gap = 4;
  const box = $('#hand');
  const cw = box.clientWidth || window.innerWidth - 16;
  let w = Math.floor((cw - (n-1)*gap) / n);
  w = Math.max(18, Math.min(28, w)); // ä¸Šä¸‹é™
  const h = Math.round(w*1.35);
  const miniW = Math.round(w*0.86), miniH = Math.round(h*0.86);
  const root = document.documentElement.style;
  root.setProperty('--tileW', w+'px');
  root.setProperty('--tileH', h+'px');
  root.setProperty('--miniW', miniW+'px');
  root.setProperty('--miniH', miniH+'px');
}
function renderAll(){
  fitTilesToHand();
  // ä½ çš„æ‰‹ç‰Œ
  const you = G.players.get('æ±');
  sortHand(you.hand);
  const handBox = $('#hand'); handBox.innerHTML='';
  you.hand.forEach((t,idx)=>{
    handBox.appendChild(tileEl(t,false,true,()=>onYouTapTile(idx)));
  });
  // ç©å®¶å€
  const root = $('#players'); root.innerHTML='';
  order.forEach(s=>{
    const p = G.players.get(s);
    const wrap = document.createElement('div'); wrap.className='player';
    const head = document.createElement('div'); head.className='phead';
    head.innerHTML = `<div class="meta"><span class="seat">${s}</span>${p.banker?'<span class="banker">èŠ</span>':''}<span>${p.name}</span></div>
      <div class="meta small"><span>ğŸ’° <span class="mono">${p.score.toLocaleString()}</span></span>
      <span>ğŸ€„ <span class="mono">${p.hand.length}</span> å¼µ</span></div>`;
    wrap.appendChild(head);
    const piles = document.createElement('div'); piles.className='piles';
    const disc = document.createElement('div'); disc.className='row';
    p.disc.forEach(t=>disc.appendChild(tileEl(t,true,false)));
    const meld = document.createElement('div'); meld.className='row';
    p.melds.forEach(g=>{
      const gEl = document.createElement('span'); gEl.style.display='flex'; gEl.style.gap='3px';
      g.forEach(t=> gEl.appendChild(tileEl(t,true,false)));
      meld.appendChild(gEl);
    });
    piles.appendChild(disc); piles.appendChild(meld); wrap.appendChild(piles);
    root.appendChild(wrap);
  });
  $('#R_left').textContent = String(G.deck.length);
  // å‹•ä½œæç¤º
  $('#hint').textContent = (G.turn==='æ±' ? (G.needDraw?'è«‹æ‘¸ç‰Œï¼ˆé»ä¸‹æ–¹ã€Œéã€ï¼‰':'è«‹å‡ºç‰Œï¼ˆé»æ‰‹ç‰Œï¼‰') : `ç­‰å¾… ${G.players.get(G.turn).name} å‡ºç‰Œâ€¦`);
}
function enableActionsForYou(){
  const toggle = (id, ena)=> $('#'+id).disabled = !ena;
  toggle('act-chi', false);
  toggle('act-ting', false);
  toggle('act-hu', canSevenPairs(G.players.get('æ±').hand)); // ä¸ƒå°è‡ªæ‘¸
  const last = G.lastDiscard, discarter = G.lastDiscarter;
  const you = G.players.get('æ±');
  let canPeng=false, canGang=false;
  if(last && discarter && discarter!== 'æ±'){
    const cnt = you.hand.filter(x=>x===last).length;
    canPeng = cnt>=2;
    canGang = cnt>=3;
  }
  toggle('act-peng', canPeng);
  toggle('act-gang', canGang);
  toggle('act-pass', true);
}
function onYouTapTile(i){
  if(G.turn!=='æ±' || G.phase!=='playing') return;
  const you = G.players.get('æ±');
  if(G.needDraw){
    log('æç¤º','éœ€å…ˆæ‘¸ç‰Œï¼ˆé»ã€Œéã€ï¼‰');
    return;
  }
  const t = you.hand.splice(i,1)[0];
  you.remain = you.hand.length;
  G.lastDiscard = t; G.lastDiscarter = 'æ±';
  you.disc.push(t);
  log('ä½ ','æ‰“å‡º '+t);
  G.turn = nextSeat(G.turn);
  G.needDraw = true;
  renderAll();
  scheduleAiChain();
}
function scheduleAiChain(){
  if(G.timer) { clearTimeout(G.timer); G.timer=null; }
  if(G.turn !== 'æ±' && G.phase==='playing'){
    G.timer = setTimeout(aiTurn, 420);
  }else{
    enableActionsForYou();
  }
}
function aiTurn(){
  if(G.phase!=='playing') return;
  const p = G.players.get(G.turn);
  if(G.needDraw && G.deck.length){
    p.hand.push(G.deck.pop());
    p.remain = p.hand.length;
    G.needDraw = false;
  }
  // ç°¡å–® AIï¼šæ‰“ç¬¬ä¸€å¼µéå­—ç‰Œï¼Œå¦å‰‡æ‰“ç¬¬ä¸€å¼µ
  let idx = p.hand.findIndex(t=>!/æ±|å—|è¥¿|åŒ—|ä¸­|ç™¼|ç™½/.test(t));
  if(idx<0) idx=0;
  const t = p.hand.splice(idx,1)[0];
  p.disc.push(t);
  G.lastDiscard = t; G.lastDiscarter = p.seat;
  log(p.name,'æ‰“å‡º '+t);
  G.turn = nextSeat(G.turn);
  G.needDraw = true; // ä¸‹ä¸€å®¶é ˆæ‘¸
  renderAll();
  // è‹¥ä¸‹ä¸€ä½ä»éæ±å®¶ï¼ŒæŒçºŒä¸²é€£ AIï¼›å¦å‰‡æ›ä½ ä¸”å¯åæ‡‰/æ‘¸ç‰Œ
  scheduleAiChain();
}
/* å‹•ä½œ */
$('#act-pass').addEventListener('click',()=>{
  if(G.phase!=='playing') return;
  if(G.turn==='æ±' && G.needDraw){
    if(G.deck.length){
      const you = G.players.get('æ±');
      const t = G.deck.pop(); you.hand.push(t); you.remain = you.hand.length;
      log('ä½ ','æ‘¸åˆ° '+t);
      G.needDraw = false;
      renderAll(); enableActionsForYou();
    }
  }else{
    // å°åˆ¥äººç‰Œé¸æ“‡é
    G.lastDiscard=null; G.lastDiscarter=null;
    enableActionsForYou();
  }
});
$('#act-peng').addEventListener('click',()=>{
  if(G.phase!=='playing') return;
  const last = G.lastDiscard; if(!last) return;
  const you = G.players.get('æ±');
  let cnt=0, keep=[]; for(const t of you.hand){ if(t===last && cnt<2){ cnt++; } else keep.push(t); }
  if(cnt===2){
    you.hand = keep;
    you.melds.push([last,last,last]);
    log('ä½ ','ç¢° '+last);
    G.turn='æ±'; G.needDraw=false; G.lastDiscard=null;
    renderAll(); enableActionsForYou();
  }
});
$('#act-gang').addEventListener('click',()=>{
  if(G.phase!=='playing') return;
  const last = G.lastDiscard; if(!last) return;
  const you = G.players.get('æ±');
  let cnt=0, keep=[]; for(const t of you.hand){ if(t===last && cnt<3){ cnt++; } else keep.push(t); }
  if(cnt===3){
    you.hand = keep;
    you.melds.push([last,last,last,last]);
    log('ä½ ','æ§“ '+last);
    if(G.deck.length){
      const t = G.deck.pop(); you.hand.push(t); you.remain = you.hand.length;
      log('ä½ ','è£œæ‘¸ '+t);
    }
    G.turn='æ±'; G.needDraw=false; G.lastDiscard=null;
    renderAll(); enableActionsForYou();
  }
});
$('#act-hu').addEventListener('click',()=>{
  if(G.phase!=='playing') return;
  const you = G.players.get('æ±');
  if(canSevenPairs(you.hand)){
    log('ä½ ','èƒ¡äº†ï¼ï¼ˆä¸ƒå° åˆ¤å®šï¼‰');
    alert('æ­å–œè‡ªæ‘¸ï¼ˆä¸ƒå°ï¼‰ï¼æœ¬ç¤ºç¯„ç‚ºç°¡åŒ–è¦å‰‡ã€‚');
    G.phase='end';
  }
});
function canSevenPairs(hand){
  const map = new Map();
  hand.forEach(t=> map.set(t, (map.get(t)||0)+1));
  let pairs=0; for(const v of map.values()){ if(v%2!==0) return false; pairs += v/2; }
  return pairs>=7 && (hand.length%2===0);
}
/* æ–°å±€ */
$('#btn-new').addEventListener('click', ()=> { setup(); });
window.addEventListener('resize', ()=>{ fitTilesToHand(); });

// åˆå§‹æ¸²æŸ“ï¼ˆæœªé–‹å±€ï¼‰
(function init(){
  $('#log').innerHTML='';
  $('#hand').innerHTML='';
  $('#players').innerHTML='';
  log('ç³»çµ±','é»ã€Œé–‹å§‹æ–°å±€ã€è©¦ç©ã€‚æ­¤å¼•æ“ç‚ºæ¦‚å¿µç‰ˆï¼šæ”¯æ´æ‘¸ï¼æ‰“ã€AI ä¸²é€£å‡ºç‰Œï¼Œã€Œç¢°ã€ã€Œæ§“ã€ã€Œä¸ƒå°è‡ªæ‘¸ã€ã€‚');
  fitTilesToHand();
})();
</script>
</body>
</html>
